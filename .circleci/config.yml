version: 2.1
jobs:
  build:
    machine:
      image: ubuntu-1604:201903-0
#    docker:
#      - image: circleci/golang:1.12.5
    steps:
#      - restore_cache:
#          key: operator-sdk-v0.9.0
#          paths:
#            - /tmp/operator-sdk
      - run:
          name: install operator-sdk
          command: |
            cd /tmp
            rm -rf operator-sdk
            git clone https://github.com/operator-framework/operator-sdk.git
            cd operator-sdk
            git checkout v0.9.0
            make install
#      - save_cache:
#          key: operator-sdk-v0.9.0
#          paths:
#            - /tmp/operator-sdk
      - checkout
      - setup_remote_docker
#      - attach_workspace:
#          at: .
      - run: make build-image
  unit-test:
    docker:
      - image: circleci/golang:1.12.5
    steps:
      - run: make unit-test
  publish-latest:
    docker:
      - image: circleci/golang:1.12.5
    steps:
      - setup_remote_docker
      - deploy:
          name: Push image to docker hub
          command: |
            docker login --username $DOCKERHUB_USER --password $DOCKERHUB_PASSWORD
            make push-image
  e2e-tests:
    docker:
      - image: circleci/golang:1.12.5
    steps:
      - run: ./scripts/kind-smoketest.sh


#workflows:
#  version: 2.1
#  build-master:
#    jobs:
#      - build:

#          filters:
#            branches:
#              only: master