version: 2.1
jobs:
  build:
    docker:
      - image: circleci/golang:1.12.5
    steps:
      - run:
          name: install operator-sdk
          command: |
            cd /tmp
            git clone https://github.com/operator-framework/operator-sdk.git
            cd operator-sdk
            git checkout v0.9.0
            make install
      - checkout
      - setup_remote_docker
      - run: make code-gen
      - run: make openapi-gen
      - run: make build-image
  unit-test:
    docker:
      - image: circleci/golang:1.12.5
    steps:
      - run: make unit-test
  publish-latest:
    docker:
      - image: circleci/golang:1.12.5
    steps:
      - setup_remote_docker
      - deploy:
          name: Push image to docker hub
          command: |
            docker login --username $DOCKERHUB_USER --password $DOCKERHUB_PASSWORD
            make push-image
  e2e-tests:
    docker:
      - image: circleci/golang:1.12.5
    steps:
      - run: ./scripts/kind-smoketest.sh


#workflows:
#  version: 2.1
#  build-master:
#    jobs:
#      - build:

#          filters:
#            branches:
#              only: master